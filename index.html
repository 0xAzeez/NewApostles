<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Apostles</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <!-- Safety Timeout Script (Non-module) -->
    <script>
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            const landing = document.getElementById('landing-screen');
            if (splash && getComputedStyle(splash).display !== 'none') {
                console.warn("Safety timeout triggered: Forcing splash screen hide");
                splash.style.opacity = '0';
                setTimeout(() => {
                    splash.style.display = 'none';
                    if (landing && getComputedStyle(landing).display === 'none') {
                        landing.style.display = 'flex';
                    }
                }, 1000);
            }
        }, 5000); // 5 seconds max for splash
    </script>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="splash-background"></div>
        <div class="splash-content">
            <img src="assets/header.png" alt="The Apostles" class="splash-image">
            <h1 class="splash-text">tHe AposTLeS</h1>
            <button id="skip-splash"
                style="margin-top: 20px; background: transparent; border: 1px solid #fff; color: #fff; padding: 10px 20px; opacity: 0; transition: opacity 1s; pointer-events: none;"
                onclick="document.getElementById('splash-screen').style.display='none'; document.getElementById('landing-screen').style.display='flex';">SKIP</button>
            <script>
                setTimeout(() => {
                    const skipBtn = document.getElementById('skip-splash');
                    if (skipBtn) {
                        skipBtn.style.opacity = '1';
                        skipBtn.style.pointerEvents = 'auto';
                    }
                }, 3000);
            </script>
        </div>
    </div>

    <!-- Landing Screen -->
    <div id="landing-screen" style="display: none;">
        <div class="landing-content">
            <img src="assets/header.png" alt="The Apostles" class="landing-image">

            <div class="requirements-box">
                <div class="req-item">
                    <img src="assets/cloud_icon.png" class="req-icon" alt="cloud">
                    <span>Sub to the son of God</span>
                </div>
                <div class="req-divider"></div>
                <div class="req-item">
                    <img src="assets/cloud_icon.png" class="req-icon" alt="cloud">
                    <span>No bots in Heaven</span>
                </div>
                <div class="req-divider"></div>
                <div class="req-item">
                    <img src="assets/cloud_icon.png" class="req-icon" alt="cloud">
                    <span>Share the gospel</span>
                </div>
            </div>

            <button id="btn-join-whitelist" class="action-btn-large">JOIN WHITELIST</button>
        </div>
    </div>

    <!-- Eligibility Screen -->
    <div id="eligibility-screen" style="display: none;">
        <div class="splash-background"></div>
        <div class="eligibility-content">
            <img src="assets/header.png" alt="The Apostles" class="eligibility-image">
            <h2 class="eligibility-title">Checking Eligibility</h2>

            <div class="eligibility-list">
                <div id="check-score" class="eligibility-item">
                    <div class="icon-container">
                        <!-- Loading -->
                        <span class="eligibility-icon loading">‚è≥</span>
                        <!-- Success -->
                        <svg class="eligibility-icon success" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke="#00FF00" />
                            <path d="M8 12l3 3 5-5" stroke="#00FF00" />
                        </svg>
                        <!-- Fail -->
                        <svg class="eligibility-icon fail" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke="#FF0000" />
                            <path d="M15 9l-6 6M9 9l6 6" stroke="#FF0000" />
                        </svg>
                    </div>
                    <span class="eligibility-text">> 0.5 Neynar Score</span>
                </div>
                <div id="check-follow" class="eligibility-item">
                    <div class="icon-container">
                        <span class="eligibility-icon loading">‚è≥</span>
                        <svg class="eligibility-icon success" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke="#00FF00" />
                            <path d="M8 12l3 3 5-5" stroke="#00FF00" />
                        </svg>
                        <svg class="eligibility-icon fail" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke="#FF0000" />
                            <path d="M15 9l-6 6M9 9l6 6" stroke="#FF0000" />
                        </svg>
                    </div>
                    <span class="eligibility-text">Following @jesus</span>
                </div>
            </div>
        </div>
    </div>

    <div id="app" style="display: none;">
        <div class="container">
            <!-- Header Image -->
            <div class="header-image-container">
                <img src="assets/header.png" alt="The Apostles" class="header-image">
            </div>

            <!-- Profile Section -->
            <div class="profile-box">
                <div class="profile-info">
                    <img id="userPfp" src="assets/icon.png" alt="Profile" class="profile-pfp">
                    <div class="profile-details">
                        <div id="userUsername" class="profile-username">Loading...</div>
                        <div id="userFid" class="profile-fid">FID: ...</div>
                    </div>
                </div>
                <div class="profile-divider"></div>
                <div class="profile-wallet">
                    <span class="wallet-label">WALLET:</span>
                    <span id="userWallet" class="wallet-address">0x51fc....9f0d</span>
                </div>
            </div>

            <!-- Verification Header -->
            <div class="section-header">VERIFICATION:</div>

            <!-- Neynar Score Box -->
            <div id="boxScore" class="verification-box failure">
                <div class="box-header">
                    <span class="box-title">NEYNAR SCORE</span>
                    <span class="box-status">{ x }</span>
                </div>
            </div>

            <!-- Follow Box -->
            <div id="boxFollow" class="verification-box failure">
                <div class="box-header">
                    <span class="box-title">@JESUS</span>
                    <span class="box-status">{ x }</span>
                </div>
                <div id="followAction" class="box-action">
                    <div class="action-text">Must follow @Jesus to register</div>
                    <button id="btnFollowAction" class="action-btn-small">FOLLOW NOW</button>
                </div>
            </div>

            <!-- Share Box -->
            <div id="boxShare" class="verification-box share-box">
                <div class="box-header">
                    <span class="box-title">SHARE</span>
                    <span class="box-status">{ REQUIRED }</span>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="footer-actions">
                <button id="whitelist-btn" class="main-action-btn" disabled>COMPLETE VERIFICATION</button>
                <button id="refresh-btn" class="refresh-btn failure">
                    <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </button>
            </div>
        </div>

    </div>

    <!-- Whitelisted Success Screen -->
    <div id="whitelisted-screen" style="display: none;">
        <div class="whitelisted-content">
            <img src="assets/header.png" alt="The Apostles" class="whitelisted-image">
            <h1 class="whitelisted-title">You're Whitelisted!</h1>
        </div>
    </div>

    <script type="module">
        import sdk from 'https://esm.sh/@farcaster/frame-sdk';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // UI Elements
        const splashScreen = document.getElementById('splash-screen');
        const landingScreen = document.getElementById('landing-screen');
        const eligibilityScreen = document.getElementById('eligibility-screen');
        const appScreen = document.getElementById('app');

        const checkScoreEl = document.getElementById('check-score');
        const checkFollowEl = document.getElementById('check-follow');

        const whitelistBtn = document.getElementById('whitelist-btn');
        const refreshBtn = document.getElementById('refresh-btn');

        // Dashboard Elements
        const boxScore = document.getElementById('boxScore');
        const boxFollow = document.getElementById('boxFollow');
        const boxShare = document.getElementById('boxShare');
        const followAction = document.getElementById('followAction');
        const btnFollowAction = document.getElementById('btnFollowAction');

        const userPfp = document.getElementById('userPfp');
        const userUsername = document.getElementById('userUsername');
        const userFid = document.getElementById('userFid');
        const userWallet = document.getElementById('userWallet');

        // Legacy items (can be removed if not used, but keeping for safety if referenced elsewhere)
        const itemFollow = document.getElementById('item-follow');
        const itemScore = document.getElementById('item-score');
        const itemShare = document.getElementById('item-share');

        // API Configuration
        const NEYNAR_API_KEY = '2EC4ECA7-935D-4F01-98E1-A2550C6CCABC';
        const TARGET_USERNAME = 'jesus';

        // Supabase Configuration
        const SUPABASE_URL = 'https://gtiegdruzeimlnbifdry.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0aWVnZHJ1emVpbWxuYmlmZHJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MjA0NTQsImV4cCI6MjA4MTI5NjQ1NH0.v6qBLp8AVx3rqibBuRzlrK_g84Qy0aqc25jxM81rMS4';

        let supabase = null;
        if (SUPABASE_URL !== 'PASTE_YOUR_SUPABASE_URL_HERE') {
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        }

        // Debug Logger
        function log(msg) {
            console.log(msg);
        }

        // State
        const state = {
            following: false,
            scoreGood: false,
            shared: false,
            user: null // Store user info for whitelist
        };

        function updateUI() {
            // Update Follow Item
            updateItemUI(itemFollow, state.following);

            // Update Score Item
            updateItemUI(itemScore, state.scoreGood);

            // Update Share Item
            updateItemUI(itemShare, state.shared);

            // Enable button if all true
            if (state.following && state.scoreGood && state.shared) {
                whitelistBtn.disabled = false;
                whitelistBtn.classList.add('enabled');
            }
        }

        function updateItemUI(element, isComplete) {
            const statusSpan = element.querySelector('.status-icon');
            if (isComplete) {
                element.classList.add('completed');
                statusSpan.textContent = '‚úì';
            } else {
                element.classList.remove('completed');
                statusSpan.textContent = '';
            }
        }

        function updateEligibilityUI(element, status) {
            const loadingIcon = element.querySelector('.eligibility-icon.loading');
            const successIcon = element.querySelector('.eligibility-icon.success');
            const failIcon = element.querySelector('.eligibility-icon.fail');
            const text = element.querySelector('.eligibility-text');

            // Reset
            loadingIcon.style.display = 'none';
            successIcon.style.display = 'none';
            failIcon.style.display = 'none';
            text.className = 'eligibility-text';

            if (status === true) {
                successIcon.style.display = 'block';
                text.classList.add('status-pass');
            } else if (status === false) {
                failIcon.style.display = 'block';
                text.classList.add('status-fail');
            } else {
                loadingIcon.style.display = 'block';
            }
        }

        // API Configuration
        // const NEYNAR_API_KEY = '2EC4ECA7-935D-4F01-98E1-A2550C6CCABC'; // Already defined above
        // const TARGET_USERNAME = 'jesus'; // Already defined above

        // Helper: Resolve Username to FID
        async function getFidForUsername(username) {
            try {
                const response = await fetch(`https://fnames.farcaster.xyz/transfers/current?name=${username}`);
                const data = await response.json();
                if (data && data.transfer && data.transfer.to) {
                    log(`Resolved @${username} to FID: ${data.transfer.to}`);
                    return data.transfer.to;
                }
                throw new Error('FID not found');
            } catch (error) {
                console.error("Error resolving username:", error);
                return null;
            }
        }

        // Real API Checks
        async function checkFollowStatus(userFid) {
            log(`Checking follow status for FID: ${userFid}`);
            if (NEYNAR_API_KEY === 'PASTE_YOUR_NEYNAR_API_KEY_HERE') {
                console.warn("Missing API Key. Returning mock success.");
                return new Promise(resolve => setTimeout(() => resolve(true), 1000));
            }

            try {
                const targetFid = await getFidForUsername(TARGET_USERNAME);
                if (!targetFid) {
                    log("Target FID not found for " + TARGET_USERNAME);
                    return false;
                }

                const url = `https://api.neynar.com/v2/farcaster/user/bulk?fids=${targetFid}&viewer_fid=${userFid}`;
                const response = await fetch(url, {
                    headers: {
                        'accept': 'application/json',
                        'api_key': NEYNAR_API_KEY
                    }
                });

                if (!response.ok) {
                    log(`Follow API Error: ${response.status}`);
                    return false;
                }

                const data = await response.json();
                if (data.users && data.users.length > 0) {
                    const isFollowing = data.users[0].viewer_context.following;
                    log(`Follow status: ${isFollowing}`);
                    return isFollowing;
                }
                log("Follow check: No user data returned");
                return false;
            } catch (error) {
                log(`Follow check failed: ${error.message}`);
                console.error("Follow check failed:", error);
                return false;
            }
        }

        async function checkNeynarScore(userFid) {
            log(`Checking score for FID: ${userFid}`);
            if (NEYNAR_API_KEY === 'PASTE_YOUR_NEYNAR_API_KEY_HERE') {
                console.warn("Missing API Key. Returning mock success.");
                return new Promise(resolve => setTimeout(() => resolve({ score: 0.85, user: null }), 1500));
            }

            try {
                const url = `https://api.neynar.com/v2/farcaster/user/bulk?fids=${userFid}`;
                const response = await fetch(url, {
                    headers: {
                        'accept': 'application/json',
                        'api_key': NEYNAR_API_KEY
                    }
                });

                if (!response.ok) {
                    log(`Score API Error: ${response.status}`);
                    return { score: 0, user: null };
                }

                const data = await response.json();
                if (data.users && data.users.length > 0) {
                    const user = data.users[0];
                    const score = user.experimental?.neynar_user_score || user.score || 0;
                    log(`User Score: ${score}`);
                    return { score, user };
                }
                log("Score check: No user data returned");
                return { score: 0, user: null };
            } catch (error) {
                log(`Score check failed: ${error.message}`);
                console.error("Score check failed:", error);
                return { score: 0, user: null };
            }
        }




        function updateDashboardUI() {
            // 1. Profile
            if (state.user) {
                userPfp.src = state.user.pfpUrl || 'assets/icon.png';
                userUsername.textContent = `@${state.user.username}`;
                userFid.textContent = `FID: ${state.user.fid}`;


                userWallet.textContent = "0x... (Connect)";
                if (state.user.verifications && state.user.verifications.length > 0) {
                    const addr = state.user.verifications[0];
                    userWallet.textContent = `${addr.slice(0, 6)}...${addr.slice(-4)}`;
                }
            }

            // 2. Neynar Score Box
            const scoreStatus = boxScore.querySelector('.box-status');
            const scoreVal = parseFloat(state.scoreVal || "0.00");

            if (scoreVal > 0.5) {
                boxScore.classList.add('success');
                boxScore.classList.remove('failure');
                scoreStatus.innerHTML = `${scoreVal} <span style="color:#00FF00">‚úì</span>`;
            } else {
                boxScore.classList.add('failure');
                boxScore.classList.remove('success');
                scoreStatus.textContent = '{ x }';
            }

            // 3. Follow Box
            const followStatus = boxFollow.querySelector('.box-status');
            if (state.following) {
                boxFollow.classList.add('success');
                boxFollow.classList.remove('failure');
                followStatus.innerHTML = `<span style="color:#00FF00">‚úì</span>`;
                followAction.style.display = 'block'; // Keep it visible but green
                boxFollow.querySelector('.action-text').textContent = 'Must follow @Jesus to register'; // Keep text
                btnFollowAction.style.display = 'none'; // Hide button
            } else {
                boxFollow.classList.add('failure');
                boxFollow.classList.remove('success');
                followStatus.textContent = '{ x }';
                followAction.style.display = 'block';
                boxFollow.querySelector('.action-text').textContent = 'Must follow @Jesus to register';
                btnFollowAction.style.display = 'inline-block';
            }

            // 4. Share Box
            const shareStatus = boxShare.querySelector('.box-status');
            if (state.shared) {
                boxShare.classList.add('success');
                boxShare.classList.remove('failure');
                boxShare.style.borderColor = '#00FF00';
                shareStatus.innerHTML = '<span style="color:#00FF00">‚úì</span>';
            } else {
                boxShare.classList.remove('success');
                boxShare.style.borderColor = '#444'; // Default border
                shareStatus.textContent = '{ REQUIRED }';
            }

            // 5. Main Button
            if (state.following && scoreVal > 0.5 && state.shared) {
                whitelistBtn.disabled = false;
                whitelistBtn.classList.add('enabled');
                refreshBtn.classList.add('success');
            } else {
                whitelistBtn.disabled = true;
                whitelistBtn.classList.remove('enabled');
                refreshBtn.classList.remove('success');
            }
        }

        // Initialize
        async function initApp() {
            try {
                // Initialize SDK background
                // In frame-sdk, we just call ready()
                sdk.actions.ready();

                // 1. Splash Screen (2.5s)
                await new Promise(resolve => setTimeout(resolve, 2500));

            } catch (error) {
                console.error("Init Error:", error);
                // log("Init Error: " + error.message); // log might not be defined if module failed
            } finally {
                // Always transition
                // Moved to finally block to ensure it happens even on error
                setTimeout(() => {
                    if (splashScreen.style.display !== 'none') {
                        splashScreen.style.opacity = '0';
                        setTimeout(() => {
                            splashScreen.style.display = 'none';
                            landingScreen.style.display = 'flex';
                        }, 1000);
                    }
                }, 2500);
            }
        }

        async function startEligibilityChecks() {
            // Transition Landing -> Eligibility
            landingScreen.style.display = 'none';
            eligibilityScreen.style.display = 'flex';

            try {
                // Probe sdk.context
                log(`sdk.context type: ${typeof sdk.context}`);

                let context = null;
                // Poll for context (up to 5 attempts)
                for (let i = 0; i < 5; i++) {
                    // Check if it's a promise or direct object
                    const rawContext = sdk.context;
                    if (rawContext && typeof rawContext.then === 'function') {
                        context = await rawContext;
                    } else {
                        context = rawContext;
                    }

                    if (context && context.user && context.user.fid) {
                        log(`Context found on attempt ${i + 1}`);
                        break;
                    }
                    log(`Attempt ${i + 1}: Context not ready. Waiting...`);
                    await new Promise(r => setTimeout(r, 500));
                }

                log("Final Context: " + JSON.stringify(context));

                // 2. Run Checks
                if (context && context.user && context.user.fid) {
                    state.user = context.user;
                    log(`User detected: ${state.user.username} (FID: ${state.user.fid})`);

                    // Update UI immediately with user info so it's ready even if checks fail
                    if (userUsername) userUsername.textContent = `@${state.user.username}`;
                    if (userFid) userFid.textContent = `FID: ${state.user.fid}`;
                    if (userPfp) userPfp.src = state.user.pfpUrl || 'assets/icon.png';

                    // Parallel Checks
                    const [following, neynarData] = await Promise.all([
                        checkFollowStatus(context.user.fid),
                        checkNeynarScore(context.user.fid)
                    ]);

                    state.following = following;
                    state.scoreVal = neynarData.score;
                    state.scoreGood = parseFloat(neynarData.score) > 0.5;

                    // Merge rich user data from Neynar (contains wallet/verifications)
                    if (neynarData.user) {
                        state.user = { ...state.user, ...neynarData.user };
                        // Force update UI again with new data
                        updateDashboardUI();
                    }

                } else {
                    log("No user in context. Falling back to Demo Mode.");
                    // Demo Mode
                    console.log("Demo Mode");
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    state.following = await checkFollowStatus(0);
                    state.scoreVal = await checkNeynarScore(0);
                    state.scoreGood = parseFloat(state.scoreVal) > 0.5;

                    // Mock User for Demo
                    state.user = {
                        username: 'demo_user',
                        fid: 1234,
                        pfpUrl: 'assets/icon.png',
                        verifications: ['0x1234567890abcdef1234567890abcdef12345678']
                    };
                }

                // Update Eligibility UI
                updateEligibilityUI(checkScoreEl, state.scoreGood);
                updateEligibilityUI(checkFollowEl, state.following);

                // 3. Transition to Main App
                setTimeout(() => {
                    eligibilityScreen.style.opacity = '0';
                    setTimeout(() => {
                        eligibilityScreen.style.display = 'none';
                        appScreen.style.display = 'block';
                        updateDashboardUI(); // Update main app UI
                    }, 1000);
                }, 2000);

            } catch (error) {
                console.error("Check Error:", error);
                // Fallback
                state.following = false;
                state.scoreGood = false;
                state.scoreVal = "0.00";
                updateEligibilityUI(checkScoreEl, false);
                updateEligibilityUI(checkFollowEl, false);
                setTimeout(() => {
                    eligibilityScreen.style.display = 'none';
                    appScreen.style.display = 'block';
                    updateDashboardUI();
                }, 2000);
            }
        }

        // Run Init
        initApp();

        // Event Listeners

        // JOIN WHITELIST button
        const btnJoinWhitelist = document.getElementById('btn-join-whitelist');
        btnJoinWhitelist.addEventListener('click', startEligibilityChecks);

        // Follow Action
        btnFollowAction.addEventListener('click', () => {
            // Open Jesus Profile
            sdk.actions.viewProfile({ fid: 2855 }); // 2855 is @jesus FID (approx, need to verify or use username lookup if SDK supports)
            // Actually, viewProfile takes { fid: number } or { username: string } depending on SDK version?
            // Documentation says { fid: number }. 
            // We resolved the FID earlier dynamically, let's use that if possible, or hardcode for now.
            // Ideally we use the resolved FID.
            // For now, let's assume the user goes and follows.
        });

        // Share Action
        boxShare.addEventListener('click', () => {
            const text = "The Big Man looked at my browser history and decided to let me in anyway. üíÄ\n\nOfficially whitelisted by @jesus Miracles do happen.\n\nCheck if you‚Äôre too cringe for salvation";
            const embedUrl = "https://farcaster.xyz/miniapps/meHZ3K2366qc/the-apostles";
            const shareUrl = `https://warpcast.com/~/compose?text=${encodeURIComponent(text)}&embeds[]=${encodeURIComponent(embedUrl)}`;

            // Use openUrl for better compatibility if createCast fails or isn't supported in all contexts
            sdk.actions.openUrl(shareUrl);

            // Optimistically set shared to true
            state.shared = true;
            updateDashboardUI();
        });

        // Refresh Action
        refreshBtn.addEventListener('click', async () => {
            if (!state.user) return;

            // Visual feedback
            refreshBtn.classList.add('rotating');

            try {
                // Re-run checks
                const [following, neynarData] = await Promise.all([
                    checkFollowStatus(state.user.fid),
                    checkNeynarScore(state.user.fid)
                ]);

                state.following = following;
                state.scoreVal = neynarData.score;
                state.scoreGood = parseFloat(neynarData.score) > 0.5;

                updateDashboardUI();
            } catch (e) {
                console.error("Refresh failed", e);
            } finally {
                // Stop rotation
                setTimeout(() => {
                    refreshBtn.classList.remove('rotating');
                }, 500);
            }
        });

        // Whitelist Action
        whitelistBtn.addEventListener('click', async () => {
            if (!state.user) return;

            whitelistBtn.textContent = 'JOINING...';
            whitelistBtn.disabled = true;

            if (!supabase) {
                alert("Supabase not configured!");
                whitelistBtn.textContent = 'COMPLETE VERIFICATION';
                whitelistBtn.disabled = false;
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('whitelist')
                    .insert([
                        { fid: state.user.fid, username: state.user.username }
                    ]);

                if (error) throw error;

                whitelistBtn.textContent = 'VERIFICATION COMPLETE';
                whitelistBtn.classList.add('success');
                // Maybe show confetti?
            } catch (err) {
                console.error(err);
                whitelistBtn.textContent = 'ERROR';
                setTimeout(() => {
                    whitelistBtn.textContent = 'COMPLETE VERIFICATION';
                    whitelistBtn.disabled = false;
                }, 2000);
            }
        });

    </script>

</body>

</html>